{"version":3,"sources":["Authentication/authentication.cljs"],"mappings":";;AAOA,6CAAA,7CAAKA;AAEL,uCAAA,vCAAKC;AAEL,0CAAA,1CAAKC;AAEL,0CAAA,1CAAKC;AAEL,GAAA,QAAAC,2CAAAC,0DAAAC;AAAA;AAAA,AAAA,AAAiBC,8CACf,iBAAMC,kBAAgBC;IAChBC,OAAK,qBAAA,2CAAA,8FAAA,sGAAA,pQAACC,yHAAiBV,mGACEC,+FACHM;IACtBI,gBAAc,KAAAC,uDAAOH;IACrBI,eAAa,AAAiBF;AALpC,AAME,AAAA,AAAIE,kBACM,WAAKC;AAAL,AACE,IAAAC,qBAAyB,iBAAAE,WAASH;AAAT,AAAA,GAAA,CAAAG,YAAA;AAAA;;AAAA,0DAAAA,nDACSC;;;AADlC,AAAA,oBAAAH;AAAA,AAAA,oBAAAA,hBAAWC;AAAX,AAEE,GAAI,uEAAA,tEAAM,0DAAA,1DAACG,4CAAIH;AACb,8BAAA,mFAAA,1GAACI,0KAAyBJ;;AAC1B,8BAAA,mFAAA,1GAACI,6LAAkCJ;;;AAJvC;;UAKD,WAAKK;AAAL,AACE,8BAAA,mFAAA,1GAACD,6LAAkCC;;;AAChDV;;;AAEJ,sCAAA,tCAAMW;AAAN,AACE,IAAMb,OAAK,qBAAA,2CAAA,8GAAA,9KAACC,mIAAsBX,yGACFG;AADhC,AAEE,OAAqBI,+DAAcG;;AAEvC,AAAKc,oDAAiB,6CAAA,WAAAC,xDAACE;AAAD,AAAO,iEAAAF,mEAAA,2EAAA,xMAACN;GAAR,WAAAO;AAAA,AAA0C,kBAAAA,XAAQE;;AACxE,AAAKC,qDAAkB,AAACF,6CAAKH,kDAAiBM;AAE9C,+CAAA,/CAAMC,sGAAgBC;AAAtB,AACE,IAAAC,aAA+C,4DAAA,5DAACK,mDAAUN;oBAA1D,AAAAE,4CAAAD,WAAA,IAAA,3EAAOE;qBAAP,AAAAD,4CAAAD,WAAA,IAAA,5EAAqBG;gBAArB,AAAAF,4CAAAD,WAAA,IAAA,vEAAoCI;IAC9BE,gBAAc,AAACV,mDAAkBM;IACjCK,iBAAe,AAACX,mDAAkBO;AAFxC,AAAA,kDAAA,sEAAA,0EAAA,xFAGWG,yEACCC,8EACEH;;AAEhB,AAAKI,wDACH,CAAA,kDAAA,rCAAkBxC,yCAAWC;AAE/B,+DAAA,/DAAMwC,sIAA2BC;AAAjC,AACE,kBAAAC;AAAA,AAAA,IAAAC,aAAAD;IAAAC,iBAAA,AAAAC,4BAAAD;UAAAA,NAAuCG;2BAAvC,AAAA5B,4CAAAyB,eAAA,lFAAaE;AAAb,AACE,IAAME,eAAO,AAACC,mBAAQ,oEAAA,mFAAA,mDAAA,1MAACC,+CAAOJ;AAA9B,AACE,GAAM,GAAKE;AAAX,AACE,OAAUN,mBAAWF,sDAAwB,4CAAK,AAAA,iFAAM,AAAA,sFAAQM;;AADlE;;;;AAGN,mEAAA,nEAAMK,8IAA+BT;AAArC,AACE;AAAA,AAAO,OAAaA,sBAAWF","names":["Authentication.authentication/redirect-uri","Authentication.authentication/domain","Authentication.authentication/client-id","Authentication.authentication/acr-mitid","js/Authentication","js/Authentication.authentication","js/Authentication.authentication.authenticator","Authentication.authentication/authenticator","session-storage","js/sessionStorage","args","cljs.core/clj->js","authenticator","js/module$node_modules$$criipto$auth_js$dist$criipto_auth","match-object","result","temp__5753__auto__","parsed-result","G__21759","cljs.core.js__GT_clj","cljs.core.get","re-frame.core/dispatch","err","Authentication.authentication/login","Authentication.authentication/json-string->clj","p1__21762#","p1__21763#","cljs.core.comp","js/JSON","Authentication.authentication/b64-enc-json->clj","goog.crypt.base64/decodeString","Authentication.authentication/parse-id-token","id-token","vec__21764","cljs.core.nth","header-base64","payload-base64","signature","clojure.string.split","header-parsed","payload-parsed","Authentication.authentication/js-storage-key-for-auth","Authentication.authentication/save-token-to-js-storage!","js-storage","p__21767","map__21768","cljs.core/--destructure-map","authorization-result","_db","error?","cljs.core/boolean","cljs.core.get_in","Authentication.authentication/remove-token-from-js-storage!"],"sourcesContent":["(ns Authentication.authentication\n  (:require [\"@criipto/auth-js\" :as auth]\n            [goog.crypt.base64 :as b64]\n            [clojure.string :as str]\n            [re-frame.core :as rf]))\n\n;; TODO use environment variable?\n(def redirect-uri \"http://localhost:3000/auth\")\n\n(def domain \"mnie-test.criipto.id\")\n\n(def client-id \"urn:mnie:1010\")\n\n(def acr-mitid \"urn:grn:authn:dk:mitid:low\")\n\n(defonce ^Object authenticator\n  (let [session-storage js/sessionStorage\n        args (clj->js {:domain domain\n                       :clientID client-id\n                       :store session-storage})\n        authenticator (auth. args)\n        match-object (.redirect.match authenticator)]\n    (.. match-object\n        (then (fn [result]\n                (when-let [parsed-result (some->> result\n                                                  js->clj)]\n                  (if (nil? (get parsed-result \"error\"))\n                    (rf/dispatch [:authorized parsed-result])\n                    (rf/dispatch [:authorization-error parsed-result])))))\n        (catch (fn [err]\n                 (rf/dispatch [:authorization-error err]))))\n    authenticator))\n\n(defn login []\n  (let [args (clj->js {:redirectUri redirect-uri\n                       :acrValues acr-mitid})]\n    (.redirect.authorize authenticator args)))\n\n(def json-string->clj (comp #(js->clj % :keywordize-keys true) #(.parse js/JSON %)))\n(def b64-enc-json->clj (comp json-string->clj b64/decodeString))\n\n(defn parse-id-token [id-token]\n  (let [[header-base64 payload-base64 signature] (str/split id-token #\"\\.\")\n        header-parsed (b64-enc-json->clj header-base64)\n        payload-parsed (b64-enc-json->clj payload-base64)]\n    {:header header-parsed\n     :payload payload-parsed\n     :signature signature}))\n\n(def js-storage-key-for-auth\n  (str \"oidc.user:\" domain \":\" client-id))\n\n(defn save-token-to-js-storage! [js-storage]\n  (fn [{:keys [authorization-result] :as _db}]\n    (let [error? (boolean (get-in authorization-result [:raw :error]))]\n      (when (not error?)\n        (.setItem js-storage js-storage-key-for-auth (str (:raw (:token authorization-result))))))))\n\n(defn remove-token-from-js-storage! [js-storage]\n  (fn [] (.removeItem js-storage js-storage-key-for-auth)))\n"]}